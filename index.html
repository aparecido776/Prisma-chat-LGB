<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>PRISMA 24H PRO</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
 --bg:#f4f5fa;
 --me:#7c3aed;
 --other:#ffffff;
 --text:#111;
 --glass:rgba(255,255,255,.65);
 --border:rgba(255,255,255,.4);
 --online:#22c55e;
}
.dark{
 --bg:#0f0f14;
 --me:#9333ea;
 --other:#1f1f2b;
 --text:#fff;
 --glass:rgba(0,0,0,.6);
 --border:rgba(255,255,255,.1);
}
*{box-sizing:border-box;}
body{
 margin:0;
 min-height:100vh;
 background:linear-gradient(135deg,#7928ca,#ff0080,#00c6ff);
 display:flex;
 justify-content:center;
 align-items:center;
 font-family:system-ui;
}

.app{
 width:100%;
 max-width:430px;
 height:94vh;
 background:var(--glass);
 backdrop-filter:blur(18px);
 border-radius:22px;
 border:1px solid var(--border);
 box-shadow:0 20px 40px rgba(0,0,0,.25);
 display:flex;
 flex-direction:column;
 overflow:hidden;
}

header{
 background:linear-gradient(135deg,#7928ca,#ff0080);
 color:white;
 padding:14px;
 text-align:center;
 font-size:20px;
 font-weight:700;
}

.top{
 display:flex;
 justify-content:space-between;
 align-items:center;
 gap:8px;
 padding:10px;
}

.top-left{
 display:flex;
 align-items:center;
 gap:8px;
 flex:1;
}

.room{
 flex:1;
 padding:10px;
 border-radius:10px;
 border:none;
 outline:none;
 font-size:14px;
}

.online-indicator{
 display:flex;
 align-items:center;
 gap:6px;
 font-size:12px;
 color:var(--text);
 opacity:.8;
}

.dot{
 width:8px;
 height:8px;
 background:var(--online);
 border-radius:50%;
}

.actions{
 display:none;
 gap:6px;
}

.actions.active{display:flex;}

.btn{
 background:linear-gradient(135deg,#7c3aed,#ec4899);
 color:white;
 border:none;
 border-radius:10px;
 padding:8px 10px;
 font-size:14px;
 cursor:pointer;
}

.btn.danger{
 background:#ef4444;
}

#messages{
 flex:1;
 padding:12px;
 overflow-y:auto;
 display:flex;
 flex-direction:column;
 gap:8px;
}

.msg{
 max-width:78%;
 padding:10px 12px;
 border-radius:16px;
 font-size:14px;
 line-height:1.4;
 word-wrap:break-word;
 box-shadow:0 4px 10px rgba(0,0,0,.08);
 position:relative;
 user-select:none;
}

.msg.selected{
 outline:2px solid #ef4444;
 background:#fee2e2 !important;
 color:#111 !important;
}

.me{
 align-self:flex-end;
 background:linear-gradient(135deg,#7c3aed,#ec4899);
 color:white;
 border-bottom-right-radius:4px;
}

.other{
 align-self:flex-start;
 background:var(--other);
 color:var(--text);
 border-bottom-left-radius:4px;
}

.user{
 font-size:12px;
 font-weight:700;
 opacity:.7;
 margin-bottom:4px;
}

.msg img{
 max-width:100%;
 border-radius:12px;
 margin-top:6px;
}

.audio-box{
 background:rgba(0,0,0,.1);
 border-radius:12px;
 padding:6px;
 margin-top:6px;
}

.dark .audio-box{background:rgba(255,255,255,.15);}

.audio-box audio{
 width:100%;
}

.audio-time{
 font-size:11px;
 text-align:right;
 opacity:.7;
 margin-top:2px;
}

.expire{
 font-size:10px;
 opacity:.6;
 margin-top:4px;
 text-align:right;
}

.typing{
 font-size:12px;
 opacity:.6;
 padding:4px 10px;
}

.input-area{
 display:flex;
 gap:6px;
 padding:10px;
 background:rgba(255,255,255,.55);
}

.dark .input-area{background:rgba(0,0,0,.4);}

.input-area input[type="text"]{
 flex:1;
 padding:12px;
 border-radius:14px;
 border:none;
 outline:none;
 font-size:14px;
}

.icon-btn{
 background:#fff;
 border:none;
 border-radius:14px;
 padding:10px 12px;
 font-size:18px;
 cursor:pointer;
}

.record-btn{
 background:#ef4444;
 color:white;
 border:none;
 border-radius:14px;
 padding:10px 12px;
 font-size:18px;
 cursor:pointer;
}
.recording{
 background:#b91c1c !important;
}
.user-list{
 max-height:160px;
 overflow-y:auto;
 padding:10px;
 display:flex;
 flex-direction:column;
 gap:6px;
}
.user-item{
 padding:8px 10px;
 border-radius:10px;
 background:rgba(255,255,255,.5);
 cursor:pointer;
 font-size:14px;
}
.user-item:hover{
 background:rgba(255,255,255,.8);
}
.dark .user-item{
 background:rgba(0,0,0,.4);
}
.modal{
 position:fixed;
 inset:0;
 background:rgba(0,0,0,.6);
 display:none;
 justify-content:center;
 align-items:center;
 z-index:999;
}
.modal-box{
 background:white;
 border-radius:18px;
 padding:16px;
 width:90%;
 max-width:360px;
}
.dark .modal-box{
 background:#1f1f2b;
 color:white;
}
.modal-box h3{
 margin-top:0;
 text-align:center;
}
.modal-box input{
 width:100%;
 padding:10px;
 border-radius:10px;
 border:none;
 outline:none;
 margin-bottom:10px;
}
.modal-actions{
 display:flex;
 gap:8px;
}
.modal-actions button{
 flex:1;
}
</style>
</head>

<body>
<div class="app">

<header>‚è≥ PRISMA PRO</header>

<!-- LOGIN -->
<div id="login" style="padding:18px;">
<h3 style="text-align:center;margin-top:0;">Entrar</h3>
<input id="username" placeholder="Seu nome">
<input id="age" type="number" placeholder="Sua idade" style="margin-top:10px;">
<input type="file" id="photo" accept="image/*" style="width:100%;margin-top:10px;">
<select id="room" style="width:100%;margin-top:10px;">
<option value="geral">üåç Geral</option>
<option value="amizade">üí¨ Amizade</option>
<option value="relacionamento">‚ù§Ô∏è Relacionamento</option>
<option value="trans">üè≥Ô∏è‚Äç‚ößÔ∏è Trans</option>
</select>
<button id="enterBtn" class="btn" style="width:100%;margin-top:12px;">Entrar</button>
</div>

<!-- CHAT -->
<div id="chat" style="display:none;flex:1;flex-direction:column;">
<div class="top">
<div class="top-left">
<select id="roomSelect" class="room">
<option value="geral">üåç Geral</option>
<option value="amizade">üí¨ Amizade</option>
<option value="relacionamento">‚ù§Ô∏è Relacionamento</option>
<option value="trans">üè≥Ô∏è‚Äç‚ößÔ∏è Trans</option>
</select>
<div class="online-indicator">
<div class="dot"></div>
<span id="onlineCount">0 online</span>
</div>
</div>

<div class="actions" id="topActions">
<button class="btn danger" id="deleteBtn">üóëÔ∏è</button>
<button class="btn" id="cancelBtn">‚úñ</button>
</div>

<button class="btn" id="darkBtn">üåô</button>
</div>

<div id="messages"></div>
<div id="typingIndicator" class="typing"></div>

<div class="input-area">
<input type="file" id="imageInput" accept="image/*" hidden>
<button class="icon-btn" id="imageBtn">üì∑</button>

<button class="record-btn" id="recordBtn">üé§</button>

<input id="messageInput" type="text" placeholder="Mensagem..." autocomplete="off">
<button class="icon-btn" id="sendBtn">‚û§</button>
<button class="icon-btn" id="privateBtn">üîí</button>
</div>
</div>

</div>

<!-- MODAL CHAT PRIVADO -->
<div class="modal" id="privateModal">
<div class="modal-box">
<h3>Chat Privado</h3>
<div class="user-list" id="userList"></div>
<div class="modal-actions">
<button class="btn danger" id="closePrivate">Cancelar</button>
</div>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc, serverTimestamp, setDoc, where } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics.js";

/* üî• SUA CONFIG FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyBoUDjHpqeW1ea-U76RzB2XJCVv29Cfl6U",
  authDomain: "prisma-85870.firebaseapp.com",
  projectId: "prisma-85870",
  storageBucket: "prisma-85870.firebasestorage.app",
  messagingSenderId: "690893603680",
  appId: "1:690893603680:web:634a274f417bfd34389405",
  measurementId: "G-X1FFK0B52S"
};

const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const db = getFirestore(app);

let user = "";
let age = 0;
let photoURL = "";
let room = "geral";
let selectedId = null;
let currentChat = "public";

// ELEMENTOS
const login = document.getElementById("login");
const chat = document.getElementById("chat");
const username = document.getElementById("username");
const ageInput = document.getElementById("age");
const photo = document.getElementById("photo");
const roomLogin = document.getElementById("room");
const roomSelect = document.getElementById("roomSelect");
const messagesDiv = document.getElementById("messages");
const input = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendBtn");
const imageBtn = document.getElementById("imageBtn");
const imageInput = document.getElementById("imageInput");
const recordBtn = document.getElementById("recordBtn");
const deleteBtn = document.getElementById("deleteBtn");
const cancelBtn = document.getElementById("cancelBtn");
const topActions = document.getElementById("topActions");
const onlineCountEl = document.getElementById("onlineCount");
const typingIndicator = document.getElementById("typingIndicator");
const privateBtn = document.getElementById("privateBtn");
const privateModal = document.getElementById("privateModal");
const userListDiv = document.getElementById("userList");
const closePrivate = document.getElementById("closePrivate");

// =======================
// LOGIN
// =======================
document.getElementById("enterBtn").onclick = () => {
 user = username.value.trim();
 age = Number(ageInput.value);
 room = roomLogin.value;
 const file = photo.files[0];

 if(!user) return alert("Digite seu nome");
 if(!age || age < 13) return alert("Idade m√≠nima: 13 anos");

 if(file){
   const reader = new FileReader();
   reader.onload = () => {
     photoURL = reader.result;
     startChat();
   };
   reader.readAsDataURL(file);
 } else {
   photoURL = "";
   startChat();
 }
};

function startChat(){
 login.style.display = "none";
 chat.style.display = "flex";
 roomSelect.value = room;
 registerOnline();
 loadMessages();
 watchOnline();
 watchTyping();
}

// TROCA DE SALA
roomSelect.onchange = () => {
 room = roomSelect.value;
 currentChat = "public";
 clearSelection();
 loadMessages();
 registerOnline();
};

// =======================
// ‚è≥ TTL
// =======================
const TTL = 24 * 60 * 60 * 1000;

// =======================
// MENSAGENS
// =======================
function loadMessages(){
 messagesDiv.innerHTML = "";

 let q;
 if(currentChat === "public"){
   q = query(collection(db, room), orderBy("time"));
 } else {
   q = query(
     collection(db, "private"),
     where("chatId", "==", currentChat),
     orderBy("time")
   );
 }

 onSnapshot(q, snap => {
   messagesDiv.innerHTML = "";
   const now = Date.now();

   snap.forEach(async docSnap => {
     const d = docSnap.data();
     const id = docSnap.id;

     if(d.expiresAt && d.expiresAt < now){
       await deleteDoc(doc(db, currentChat === "public" ? room : "private", id));
       return;
     }

     const div = document.createElement("div");
     div.className = "msg " + (d.user === user ? "me" : "other");
     div.dataset.id = id;

     const remaining = Math.max(0, Math.floor((d.expiresAt - now)/1000));
     const m = Math.floor(remaining/60);
     const s = remaining % 60;

     div.innerHTML = `
       ${d.user !== user ? `<div class="user">${d.user}</div>` : ``}
       ${d.text ? `<div>${d.text}</div>` : ``}
       ${d.image ? `<img src="${d.image}">` : ``}
       ${d.audio ? `
         <div class="audio-box">
           <audio controls src="${d.audio}" preload="metadata"></audio>
           <div class="audio-time">${d.audioDuration || ""}</div>
         </div>
       ` : ``}
       <div class="expire">‚è≥ ${m}:${s.toString().padStart(2,"0")}</div>
     `;

     if(d.user === user){
       div.addEventListener("touchstart", () => selectMessage(div), {passive:true});
       div.addEventListener("mousedown", () => selectMessage(div));
     }

     messagesDiv.appendChild(div);
   });
   messagesDiv.scrollTop = messagesDiv.scrollHeight;
 });
}

// =======================
// SELECIONAR / APAGAR
// =======================
function selectMessage(div){
 clearSelection();
 div.classList.add("selected");
 selectedId = div.dataset.id;
 topActions.classList.add("active");
}

function clearSelection(){
 const sel = document.querySelector(".msg.selected");
 if(sel) sel.classList.remove("selected");
 selectedId = null;
 topActions.classList.remove("active");
}

deleteBtn.onclick = async () => {
 if(!selectedId) return;
 if(confirm("Apagar esta mensagem?")){
   await deleteDoc(doc(db, currentChat === "public" ? room : "private", selectedId));
   clearSelection();
 }
};

cancelBtn.onclick = clearSelection;

// =======================
// ENVIO
// =======================
async function send(text="", image="", audio="", audioDuration=""){
 if(!text && !image && !audio) return;

 input.value = "";
 imageInput.value = "";

 const data = {
   user,
   age,
   photo: photoURL,
   text,
   image,
   audio,
   audioDuration,
   time: serverTimestamp(),
   expiresAt: Date.now() + TTL
 };

 if(currentChat === "public"){
   await addDoc(collection(db, room), data);
 } else {
   data.chatId = currentChat;
   await addDoc(collection(db, "private"), data);
 }
}

sendBtn.onclick = () => send(input.value.trim());

input.addEventListener("keydown", e => {
 if(e.key === "Enter"){
   e.preventDefault();
   send(input.value.trim());
 }
});

// =======================
// IMAGEM
// =======================
imageBtn.onclick = () => imageInput.click();

imageInput.onchange = () => {
 const file = imageInput.files[0];
 if(!file) return;
 const reader = new FileReader();
 reader.onload = () => send("", reader.result, "", "");
 reader.readAsDataURL(file);
};

// =======================
// üé§ √ÅUDIO
// =======================
let mediaRecorder;
let audioChunks = [];
let startTime = 0;

async function startRecording(){
 const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
 mediaRecorder = new MediaRecorder(stream);
 audioChunks = [];
 startTime = Date.now();

 mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
 mediaRecorder.onstop = () => {
   const blob = new Blob(audioChunks, { type:"audio/webm" });
   const duration = Math.round((Date.now() - startTime)/1000);
   const reader = new FileReader();
   reader.onload = () => send("", "", reader.result, formatTime(duration));
   reader.readAsDataURL(blob);
 };
 mediaRecorder.start();
 recordBtn.classList.add("recording");
 recordBtn.textContent = "‚èπ";
}

function stopRecording(){
 if(mediaRecorder && mediaRecorder.state !== "inactive"){
   mediaRecorder.stop();
 }
 recordBtn.classList.remove("recording");
 recordBtn.textContent = "üé§";
}

recordBtn.onmousedown = startRecording;
recordBtn.onmouseup = stopRecording;
recordBtn.ontouchstart = e => { e.preventDefault(); startRecording(); };
recordBtn.ontouchend = e => { e.preventDefault(); stopRecording(); };

function formatTime(sec){
 const m = Math.floor(sec/60);
 const s = sec % 60;
 return `${m}:${s.toString().padStart(2,"0")}`;
}

// =======================
// üîä SOM
// =======================
const audioNotify = new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg");
let lastCount = 0;

function playSound(){
 audioNotify.currentTime = 0;
 audioNotify.play().catch(()=>{});
}

function watchSound(){
 const q = query(collection(db, room), orderBy("time"));
 onSnapshot(q, snap => {
   if(snap.size > lastCount){
     playSound();
     lastCount = snap.size;
   }
 });
}

// =======================
// üë• ONLINE
// =======================
function registerOnline(){
 const ref = doc(db, "online", `${room}_${user}`);
 setDoc(ref, {
   user,
   room,
   time: serverTimestamp()
 });
 window.addEventListener("beforeunload", () => {
   deleteDoc(ref);
 });
}

function watchOnline(){
 const q = query(collection(db, "online"));
 onSnapshot(q, snap => {
   let count = 0;
   snap.forEach(d => {
     const data = d.data();
     if(data.room === room) count++;
   });
   onlineCountEl.textContent = count + " online";
 });
}

// =======================
// ‚úçÔ∏è DIGITANDO
// =======================
let typingTimeout;

input.addEventListener("input", () => {
 if(!user) return;
 setDoc(doc(db, "typing", `${room}_${user}`), {
   user,
   room,
   time: serverTimestamp()
 });
 clearTimeout(typingTimeout);
 typingTimeout = setTimeout(() => {
   deleteDoc(doc(db, "typing", `${room}_${user}`));
 }, 2000);
});

function watchTyping(){
 const q = query(collection(db, "typing"));
 onSnapshot(q, snap => {
   let names = [];
   snap.forEach(d => {
     const data = d.data();
     if(data.room === room && data.user !== user){
       names.push(data.user);
     }
   });
   typingIndicator.textContent = names.length ? names.join(", ") + " digitando..." : "";
 });
}

// =======================
// üåô DARK MODE
// =======================
document.getElementById("darkBtn").onclick = () => {
 document.body.classList.toggle("dark");
};

// =======================
// üîí CHAT PRIVADO
// =======================
privateBtn.onclick = () => {
 privateModal.style.display = "flex";
 loadPrivateUsers();
};

closePrivate.onclick = () => {
 privateModal.style.display = "none";
};

function loadPrivateUsers(){
 const q = query(collection(db, "online"));
 onSnapshot(q, snap => {
   userListDiv.innerHTML = "";
   snap.forEach(d => {
     const data = d.data();
     if(data.room === room && data.user !== user){
       const div = document.createElement("div");
       div.className = "user-item";
       div.textContent = data.user;
       div.onclick = () => openPrivateChat(data.user);
       userListDiv.appendChild(div);
     }
   });
 });
}

function openPrivateChat(other){
 privateModal.style.display = "none";
 currentChat = [user, other].sort().join("_");
 clearSelection();
 loadMessages();
}

// INICIAR
watchSound();
</script>

</body>
</html>